<!DOCTYPE html>
<html>
  <head>
    <title>blog :skull:</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml"></link>
    <link rel="stylesheet" href="style.css"></link>
  </head>
  
  <body>
	  <iframe style="border:1px solid white; width: 100%; height: 100%" src="index.html"></iframe>
	  <div style="position:absolute; width: 0px; height: 1em; background: transparent; top: 80px; left: calc(130px + 0.5ch); border-left: 2px solid cyan"></div>
	  <button onclick="spreed()">spreed</button>
<script>
function getTextNodes(element){
	let ni = document.createNodeIterator(element, NodeFilter.SHOW_TEXT, (nd)=>nd.parentElement.checkVisibility() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT);

	let nds = [];
	let nd;
	while(1){
		nd = ni.nextNode();
		if(nd == null)
			break;
		nds.push(nd);
	};
	return nds;
}

function getStrPos(nodes, pos, count){
	for(let i = 0; i < nodes.length; i++){
		if(pos < nodes[i].length){
			console.log("thing at", i);
			let range = document.createRange();
			range.setStart(nodes[i], pos);
			range.setEnd(nodes[i], pos + count);
			return range.getBoundingClientRect();
		}
		pos -= nodes[i].length;
	}
}

function getNodeStr(nodes){
	return nodes.reduce((a, b)=>a + b.textContent, "");
}

let str;
function spreed(){
	let element = document.getElementsByTagName("iframe")[0].contentWindow.document.body;
	let nodes = getTextNodes(element);
	console.log(nodes);
	element.style.transform = "";

	let cx = 0, cy = 0;
	let wpx = 100, wpy = 50;

	str = getNodeStr(nodes);

	let si = str.matchAll(/[^\s]+/g);

	let fn = ()=>{
		let del = 100;
		let cm = si.next().value;
		if(!cm)
			return;

		let pos = getStrPos(nodes, cm.index + Math.min(cm[0].length >> 1.0, 3), 1);

		if(pos){
			let mx = pos.x + pos.width / 2;
			let my = pos.y + pos.height / 2;
			
			let dx = wpx - mx;
			let dy = wpy - my;

			if(Math.sqrt(dx * dx + dy * dy) > 80){
				del *= 2;
			}

			cx += dx;
			cy += dy;

			element.style.transform = `translate(${cx}px,${cy}px)`;
			//element.style.transition = "transform 0.05s 0s";
		}
		setTimeout(fn, del);
	}

	fn();
}
</script>
  </body>
</html>
